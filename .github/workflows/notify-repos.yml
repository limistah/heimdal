name: Notify Package Repositories

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.1)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.1)'
        required: true

permissions:
  contents: read

jobs:
  notify-repositories:
    name: Notify Package Repositories
    runs-on: ubuntu-latest
    
    steps:
      - name: Set version variables
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV
          echo "Notifying repositories about version: ${VERSION} (${TAG})"
      
      - name: Trigger Homebrew tap update
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.HOMEBREW_TAP_TOKEN }}" \
            https://api.github.com/repos/limistah/homebrew-tap/dispatches \
            -d "{\"event_type\":\"heimdal-release\",\"client_payload\":{\"version\":\"${VERSION}\",\"tag\":\"${TAG}\"}}"
      
      - name: Trigger APT repository update
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.APT_REPO_TOKEN }}" \
            https://api.github.com/repos/limistah/apt-repo/dispatches \
            -d "{\"event_type\":\"heimdal-release\",\"client_payload\":{\"version\":\"${VERSION}\",\"tag\":\"${TAG}\"}}"
      
      - name: Trigger APK repository update
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.APK_REPO_TOKEN }}" \
            https://api.github.com/repos/limistah/apk-repo/dispatches \
            -d "{\"event_type\":\"heimdal-release\",\"client_payload\":{\"version\":\"${VERSION}\",\"tag\":\"${TAG}\"}}"
      
      - name: Create summary
        run: |
          echo "## Package Repository Notifications Sent! ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notified Repositories:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Homebrew Tap" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… APT Repository" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… APK Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each repository will automatically update within a few minutes." >> $GITHUB_STEP_SUMMARY
